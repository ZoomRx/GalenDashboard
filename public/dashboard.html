<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galen Usage Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.1/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/daterangepicker@3.1.0/daterangepicker.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/daterangepicker@3.1.0/daterangepicker.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Theme Variables */
        :root {
            /* Light Theme (default) */
            --primary-color: #4361ee;
            --secondary-color: #3f37c9;
            --accent-color: #4895ef;
            --text-color: #343a40;
            --body-bg: #f5f7fb;
            --card-bg: #ffffff;
            --border-color: #dee2e6;
            --border-hover: #adb5bd;
            --header-bg: #ffffff;
            --header-text: #343a40;
            --nav-tab-active-color: var(--primary-color);
            --nav-tab-color: #495057;
            --metric-value-color: var(--primary-color);
            --metric-label-color: #6c757d;
            --table-header-bg: #f8f9fa;
            --table-row-hover: rgba(0, 0, 0, 0.05);
            --toast-bg: #ffffff;
            --chart-grid-color: rgba(0, 0, 0, 0.1);
            --filter-container-bg: #ffffff;
            --shadow-color: rgba(0, 0, 0, 0.05);
            --toast-shadow: rgba(0, 0, 0, 0.1);
            --tooltip-bg: #343a40;
            --tooltip-color: #ffffff;
            --dashboard-padding: 20px;
            --btn-outline-hover-bg: #f1f3f9;
            --link-color: #4361ee;
            --link-hover-color: #3f37c9;
        }

        /* Dark Theme */
        html[data-theme="dark"] {
            --primary-color: #5e72e4;
            --secondary-color: #5e60ce;
            --accent-color: #7987e9;
            --text-color: #e9ecef;
            --body-bg: #1a1d21;
            --card-bg: #272a30;
            --border-color: #3b3f46;
            --border-hover: #6c757d;
            --header-bg: #23262c;
            --header-text: #e9ecef;
            --nav-tab-active-color: var(--primary-color);
            --nav-tab-color: #ced4da;
            --metric-value-color: #82bafc;
            --metric-label-color: #adb5bd;
            --table-header-bg: #23262c;
            --table-row-hover: rgba(255, 255, 255, 0.08);
            --toast-bg: #272a30;
            --chart-grid-color: rgba(255, 255, 255, 0.1);
            --filter-container-bg: #272a30;
            --shadow-color: rgba(0, 0, 0, 0.15);
            --toast-shadow: rgba(0, 0, 0, 0.5);
            --tooltip-bg: #e9ecef;
            --tooltip-color: #1a1d21;
            --dashboard-padding: 20px;
            --btn-outline-hover-bg: #32353b;
            --link-color: #82bafc;
            --link-hover-color: #a3cfff;
        }

        /* Apply theme variables */
        body { 
            font-family: 'Segoe UI', 'Roboto', sans-serif; 
            background-color: var(--body-bg); 
            color: var(--text-color); 
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Fix hover states for dark mode */
        html[data-theme="dark"] .btn:hover {
            color: #fff;
        }
        
        html[data-theme="dark"] .btn-outline-secondary:hover {
            background-color: var(--btn-outline-hover-bg);
            color: #fff;
            border-color: var(--border-hover);
        }
        
        html[data-theme="dark"] .btn-outline-primary:hover {
            color: #fff;
        }
        
        html[data-theme="dark"] .dropdown-item:hover {
            color: #fff;
            background-color: var(--btn-outline-hover-bg);
        }
        
        html[data-theme="dark"] a:hover {
            color: var(--primary-color);
        }
        
        /* Ensure hover states for all buttons maintain proper contrast */
        .btn:hover {
            color: inherit;
        }

        /* Specific colors for outline buttons in dark theme */
        html[data-theme="dark"] .btn-outline-primary {
            color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        html[data-theme="dark"] .btn-outline-primary:hover {
            background-color: var(--primary-color);
            color: #fff;
        }
        
        html[data-theme="dark"] .btn-success {
            background-color: #198754;
            border-color: #198754;
        }
        
        html[data-theme="dark"] .btn-success:hover {
            background-color: #157347;
            border-color: #146c43;
        }

        .dashboard-header { 
            background-color: var(--header-bg); 
            padding: var(--dashboard-padding); 
            box-shadow: 0 2px 4px var(--shadow-color); 
            border-bottom: 1px solid var(--border-color); 
            color: var(--header-text);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .card { 
            border-radius: 10px; 
            box-shadow: 0 4px 6px var(--shadow-color); 
            margin-bottom: 20px; 
            border: none; 
            transition: all 0.3s ease; 
            background-color: var(--card-bg);
            color: var(--text-color);
        }
        .card:hover { 
            box-shadow: 0 8px 15px var(--shadow-color); 
            transform: translateY(-2px); 
        }
        .card-header { 
            background-color: var(--card-bg); 
            border-bottom: 1px solid var(--border-color); 
            font-weight: 600; 
            padding: 15px 20px; 
            border-top-left-radius: 10px !important; 
            border-top-right-radius: 10px !important; 
            color: var(--text-color);
        }
        .metric-card .card-body { padding: 25px; }
        .metric-value { 
            font-size: 32px; 
            font-weight: 700; 
            margin-bottom: 5px; 
            color: var(--metric-value-color); 
        }
        .metric-label { 
            font-size: 14px; 
            color: var(--metric-label-color); 
            margin-bottom: 0; 
        }
        .filter-container { 
            background-color: var(--filter-container-bg); 
            padding: 15px; 
            border-radius: 10px; 
            box-shadow: 0 2px 4px var(--shadow-color); 
            margin-bottom: 20px; 
            transition: background-color 0.3s ease;
        }
        .tab-content { padding: 20px 0; }
        .tab-pane { animation: fadeIn 0.5s; }
        .nav-tabs .nav-link { 
            color: var(--nav-tab-color); 
            font-weight: 500; 
            border: none; 
            padding: 10px 15px; 
            transition: color 0.3s ease;
        }
        .nav-tabs .nav-link.active { 
            color: var(--nav-tab-active-color); 
            border-bottom: 3px solid var(--nav-tab-active-color); 
            background-color: transparent; 
        }
        .table { 
            border-collapse: separate; 
            border-spacing: 0; 
            width: 100%;
            color: var(--text-color);
        }
        .table th { 
            background-color: var(--table-header-bg); 
            font-weight: 600; 
            white-space: nowrap;
            color: var(--text-color);
        }
        .table td, .table th { 
            padding: 12px 15px; 
            vertical-align: middle; 
            border-color: var(--border-color);
        }
        .table-hover tbody tr:hover {
            background-color: var(--table-row-hover);
            color: var(--text-color);
        }
        /* Fix dark mode hover table text */
        html[data-theme="dark"] .table-hover tbody tr:hover {
            color: var(--text-color) !important;
        }
        /* Fix Langfuse button styling */
        .btn-outline-secondary.langfuse-btn {
            text-decoration: none !important;
        }
        .btn-outline-secondary.langfuse-btn:hover {
            text-decoration: none !important;
        }
        html[data-theme="light"] .btn-outline-secondary.langfuse-btn {
            background-color: transparent;
            border-color: var(--border-color);
        }
        html[data-theme="light"] .btn-outline-secondary.langfuse-btn:hover {
            background-color: #f0e6d7;
            border-color: #d3c4ad;
            color: var(--text-color);
        }
        html[data-theme="dark"] .btn-outline-secondary.langfuse-btn {
            color: var(--text-color);
        }
        html[data-theme="dark"] .btn-outline-secondary.langfuse-btn:hover {
            color: var(--text-color);
            text-decoration: none;
        }
        #userTable td:nth-child(1),
        #conversationTable td:nth-child(1),
        #sessionTable td:nth-child(1),
        #modelTable td:nth-child(1) { word-break: break-all; } /* Allow long IDs/names to wrap */
        .loader { 
            border: 4px solid var(--border-color); 
            border-top: 4px solid var(--primary-color); 
            border-radius: 50%; 
            width: 30px; 
            height: 30px; 
            animation: spin 1s linear infinite; 
            margin: 20px auto; 
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .daterangepicker { 
            font-family: 'Segoe UI', 'Roboto', sans-serif;
            border-color: var(--border-color);
        }
        .daterangepicker .calendar-table {
            background-color: var(--card-bg);
            border-color: var(--border-color);
        }
        .daterangepicker .calendar-table th,
        .daterangepicker .calendar-table td {
            color: var(--text-color);
        }
        .daterangepicker .drp-buttons {
            border-color: var(--border-color);
        }
        #dateRangeFilter { 
            background-color: var(--card-bg); 
            border: 1px solid var(--border-color); 
            cursor: pointer; 
            padding: 8px 12px; 
            border-radius: 5px;
            color: var(--text-color);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .badge-agent { font-size: 11px; padding: 4px 8px; border-radius: 12px; white-space: nowrap; }
        /* Define agent colors - Add more as needed */
        .agent-hcp_p { background-color: #8ac926; color: white; }
        .agent-scoping { background-color: #1982c4; color: white; }
        .agent-synapse { background-color: #6a4c93; color: white; }
        .agent-hashtag { background-color: #ff595e; color: white; }
        .agent-survey_coding { background-color: #ffca3a; color: black; }
        .agent-unknown { background-color: #adb5bd; color: white; }
        .agent-default { background-color: #6c757d; color: white; } /* Fallback */
        .progress { height: 8px; border-radius: 4px; }
        .dropdown-item:hover { background-color: var(--btn-outline-hover-bg); }
        .dropdown-item.active { background-color: var(--primary-color); }
        .dropdown-menu {
            background-color: var(--card-bg);
            border-color: var(--border-color);
        }
        .dropdown-item {
            color: var(--text-color);
        }
        th[data-field] { cursor: pointer; }
        .sorting-asc::after { content: ' ↑'; color: var(--primary-color); font-size: 0.8em; }
        .sorting-desc::after { content: ' ↓'; color: var(--primary-color); font-size: 0.8em; }
        .pagination-controls { 
            margin-top: 1rem; 
            padding: 0.5rem; 
            background-color: var(--table-header-bg); 
            border-radius: 0.25rem; 
        }
        .pagination-info { color: var(--metric-label-color); font-size: 0.875rem; }

        /* Style for clickable links (COMMENTED OUT) */
        /* td a { color: var(--primary-color); text-decoration: none; } */
        /* td a:hover { text-decoration: underline; } */
         /* Fix Model Usage Alignment */
        #modelTable th, #modelTable td { text-align: right; } /* Right-align numeric data */
        #modelTable th:first-child, #modelTable td:first-child { text-align: left; } /* Left-align model name */
        /* Quick date filter styles */
        .quick-date-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 5px;
        }
        .quick-date-filters button {
            font-size: 11px;
            padding: 2px 8px;
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }
        .quick-date-filters button.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        .btn-outline-secondary {
            color: var(--text-color);
            border-color: var(--border-color);
        }
        .btn-outline-secondary:hover {
            background-color: var(--btn-outline-hover-bg);
            color: var(--text-color);
            border-color: var(--border-hover);
        }
        #dateRangeFilter {
            min-width: 220px; /* Ensure filter input has enough width for dates */
            text-align: center;
        }
        /* Fix daterangepicker appearance */
        .daterangepicker td.active, .daterangepicker td.active:hover {
            background-color: var(--primary-color) !important;
        }
        .daterangepicker .ranges li.active {
            background-color: var(--primary-color) !important;
        }
        
        /* Toast notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 350px;
        }
        .toast {
            background-color: var(--toast-bg);
            margin-bottom: 10px;
            box-shadow: 0 4px 8px var(--toast-shadow);
            border-left: 4px solid var(--primary-color);
            overflow: hidden;
            color: var(--text-color);
        }
        .toast-header {
            background-color: var(--table-header-bg);
            padding: 0.5rem 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-weight: 600;
            color: var(--text-color);
        }
        .toast-body {
            padding: 0.75rem 1rem;
        }
        .toast-header .close {
            font-size: 1.25rem;
            cursor: pointer;
            opacity: 0.5;
            margin-left: 15px;
            color: var(--text-color);
        }
        .toast-progress {
            height: 4px;
            background-color: var(--primary-color);
            width: 0%;
            transition: width 300ms ease;
        }
        .toast-success {
            border-left-color: #28a745;
        }
        .toast-warning {
            border-left-color: #ffc107;
        }
        .toast-error {
            border-left-color: #dc3545;
        }
        .toast-info {
            border-left-color: var(--primary-color);
        }
        .toast-success .toast-progress {
            background-color: #28a745;
        }
        .toast-warning .toast-progress {
            background-color: #ffc107;
        }
        .toast-error .toast-progress {
            background-color: #dc3545;
        }
        .toast-info .toast-progress {
            background-color: var(--primary-color);
        }

        /* Form controls styling */
        .form-control, .form-select {
            background-color: var(--card-bg);
            border-color: var(--border-color);
            color: var(--text-color);
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }
        .form-control:focus, .form-select:focus {
            background-color: var(--card-bg);
            border-color: var(--primary-color);
            color: var(--text-color);
            box-shadow: 0 0 0 0.25rem rgba(67, 97, 238, 0.25);
        }
        
        /* Theme toggler styling */
        .theme-toggle {
            border: none;
            background: transparent;
            color: var(--text-color);
            font-size: 1.2rem;
            cursor: pointer;
            transition: transform 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            border-radius: 50%;
        }
        .theme-toggle:hover {
            transform: scale(1.1);
            background-color: var(--btn-outline-hover-bg);
        }
        
        /* Fix modals for dark theme */
        .modal-content {
            background-color: var(--card-bg);
            border-color: var(--border-color);
            color: var(--text-color);
        }
        .modal-header, .modal-footer {
            border-color: var(--border-color);
        }
        
        /* Different button styles for each theme */
        html[data-theme="dark"] .btn-close {
            filter: brightness(2);
        }
        html[data-theme="light"] .btn-close {
            filter: none;
        }
        
        /* Chart JS customizations */
        #dailyUsageChart, #agentDistributionChart, #traceGraph {
            transition: all 0.3s ease;
        }
        
        /* Enhanced tooltip styles for dark mode */
        html[data-theme="dark"] .tooltip {
            --bs-tooltip-bg: var(--card-bg);
            --bs-tooltip-color: var(--text-color);
        }
        
        html[data-theme="dark"] .tooltip .tooltip-inner {
            background-color: var(--card-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }
        
        /* Fix date range picker for dark mode */
        html[data-theme="dark"] .daterangepicker {
            background-color: var(--card-bg);
            color: var(--text-color);
            border-color: var(--border-color);
        }
        
        html[data-theme="dark"] .daterangepicker .calendar-table {
            background-color: var(--card-bg);
            border-color: var(--border-color);
        }
        
        html[data-theme="dark"] .daterangepicker .drp-buttons {
            border-color: var(--border-color);
        }
        
        html[data-theme="dark"] .daterangepicker .drp-selected {
            color: var(--text-color);
        }
        
        html[data-theme="dark"] .daterangepicker td.off, 
        html[data-theme="dark"] .daterangepicker td.off.in-range, 
        html[data-theme="dark"] .daterangepicker td.off.start-date, 
        html[data-theme="dark"] .daterangepicker td.off.end-date {
            background-color: rgba(0, 0, 0, 0.2);
            color: rgba(255, 255, 255, 0.4);
        }
        
        html[data-theme="dark"] .daterangepicker .ranges li:hover {
            background-color: var(--btn-outline-hover-bg);
            color: #fff;
        }
        
        /* Improve contrast for view buttons in tables */
        html[data-theme="dark"] .btn-outline-primary,
        html[data-theme="dark"] .btn-outline-secondary {
            border-width: 1.5px;
        }
        
        html[data-theme="dark"] .view-trace-graph:hover,
        html[data-theme="dark"] .btn-outline-secondary:hover {
            border-color: #fff;
            color: #fff;
        }
        
        /* Links should use theme colors */
        a {
            color: var(--link-color);
            text-decoration: none;
        }
        
        a:hover {
            color: var(--link-hover-color);
            text-decoration: underline;
        }

        /* Fix button colors for dark theme */
        html[data-theme="dark"] .btn {
            transition: color 0.3s ease, background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }
        
        /* Fix outline buttons for dark theme */
        html[data-theme="dark"] .btn-outline-primary {
            color: var(--primary-color);
            border-color: var(--primary-color);
            background-color: transparent;
        }
        
        html[data-theme="dark"] .btn-outline-primary:hover {
            color: #fff;
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        html[data-theme="dark"] .btn-outline-secondary {
            color: var(--text-color);
            border-color: var(--border-color);
            background-color: transparent;
        }
        
        html[data-theme="dark"] .btn-outline-secondary:hover {
            color: #fff;
            background-color: var(--border-hover);
            border-color: var(--border-hover);
        }
        
        /* Fix date preset buttons */
        html[data-theme="dark"] .date-preset {
            color: var(--text-color);
            border-color: var(--border-color);
        }
        
        html[data-theme="dark"] .date-preset:hover {
            background-color: var(--btn-outline-hover-bg);
            color: #fff;
            border-color: var(--border-hover);
        }
        
        html[data-theme="dark"] .date-preset.active {
            background-color: var(--primary-color);
            color: #fff;
            border-color: var(--primary-color);
        }
        
        /* Fix table action buttons */
        html[data-theme="dark"] .view-trace-graph, 
        html[data-theme="dark"] td .btn-outline-secondary {
            background-color: transparent;
            color: var(--text-color);
            border-color: var(--border-color);
            border-width: 1px;
        }
        
        html[data-theme="dark"] .view-trace-graph:hover, 
        html[data-theme="dark"] td .btn-outline-secondary:hover {
            background-color: var(--border-hover);
            color: #fff;
            border-color: var(--border-hover);
        }

        /* Fix subtitle and timestamp text colors in dark mode */
        html[data-theme="dark"] .text-muted {
            color: #adb5bd !important;
        }
        
        /* Ensure the last refresh text is visible in both themes */
        #lastDataFetch {
            color: var(--metric-label-color);
        }
        
        html[data-theme="dark"] #lastDataFetch {
            color: #adb5bd;
        }

        /* Style for the dashboard subtitle */
        .dashboard-subtitle {
            color: var(--metric-label-color);
        }
        
        html[data-theme="dark"] .dashboard-subtitle {
            color: #adb5bd;
        }
    </style>
</head>
<body>
    <template id="paginationTemplate">
        <div class="d-flex justify-content-between align-items-center mt-3 pagination-controls-inner">
            <div class="pagination-info">
                Showing <span class="showing-start">1</span>-<span class="showing-end">50</span> of <span class="total-items">0</span>
            </div>
            <div class="btn-group">
                <button class="btn btn-outline-primary btn-sm prev-page" disabled><i class="fas fa-chevron-left"></i> Previous</button>
                <button class="btn btn-outline-primary btn-sm next-page">Next <i class="fas fa-chevron-right"></i></button>
            </div>
        </div>
    </template>

    <div class="dashboard-header">
        <div class="container-fluid">
            <div class="row align-items-center">
                 <div class="col-md-6">
                    <h2 class="mb-0">Galen Usage Dashboard</h2>
                    <p class="dashboard-subtitle mb-0">Monitor token usage, costs, and conversations across all agents</p>
                </div>
                <div class="col-md-6 text-end">
                    <div class="d-flex justify-content-end align-items-center">
                        <button id="themeToggle" class="theme-toggle me-3" aria-label="Toggle theme">
                            <i class="fas fa-sun"></i>
                        </button>
                        <div class="me-3">
                            <label for="dateRangeFilter" class="visually-hidden">Date Range:</label>
                            <input type="text" id="dateRangeFilter" class="form-control form-control-sm" readonly>
                            <div class="quick-date-filters">
                                <button class="btn btn-outline-secondary btn-sm date-preset" data-days="1">24h</button>
                                <button class="btn btn-outline-secondary btn-sm date-preset" data-days="3">3d</button>
                                <button class="btn btn-outline-secondary btn-sm date-preset" data-days="7">7d</button>
                                <button class="btn btn-outline-secondary btn-sm date-preset" data-days="14">14d</button>
                                <button class="btn btn-outline-secondary btn-sm date-preset" data-days="30">30d</button>
                            </div>
                        </div>
                        <div class="d-flex flex-column align-items-end">
                        <button id="fetchLatestButton" class="btn btn-success btn-sm ms-2">
                            <i class="fas fa-sync-alt"></i> Refresh Data
                        </button>
                            <div id="refreshStatusBanner" class="text-primary fw-bold small mt-1" style="display: none;"></div>
                        </div>
                    </div>
                     <div id="lastDataFetch" class="text-muted small mt-1 text-end" style="font-size: 0.75rem;"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid py-4">
        <div class="row mb-4">
            <div class="col-12">
                <div class="filter-container">
                    <div class="row g-3 align-items-end">
                        <div class="col-md-6">
                            <label for="agentFilter" class="form-label mb-1 small">Agent</label>
                            <select id="agentFilter" class="form-select form-select-sm">
                                <option value="all">All Agents</option>
                                </select>
                        </div>
                        <div class="col-md-6">
                             <label for="userFilter" class="form-label mb-1 small">User</label>
                            <select id="userFilter" class="form-select form-select-sm">
                                <option value="all">All Users</option>
                                </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-lg col-md-4 col-sm-6 mb-3">
                <div class="card metric-card h-100">
                    <div class="card-body text-center">
                        <h6 class="metric-label text-uppercase small">Total Tokens</h6>
                        <div id="totalTokensValue" class="metric-value">0</div>
                    </div>
                </div>
            </div>
            <div class="col-lg col-md-4 col-sm-6 mb-3">
                <div class="card metric-card h-100">
                    <div class="card-body text-center">
                        <h6 class="metric-label text-uppercase small">Total Cost (USD)</h6>
                        <div id="totalCostValue" class="metric-value">$0.00</div>
                    </div>
                </div>
            </div>
            <div class="col-lg col-md-4 col-sm-6 mb-3">
                <div class="card metric-card h-100">
                    <div class="card-body text-center">
                        <h6 class="metric-label text-uppercase small">Traces</h6>
                        <div id="totalConversationsValue" class="metric-value">0</div>
                    </div>
                </div>
            </div>
            <div class="col-lg col-md-6 col-sm-6 mb-3">
                <div class="card metric-card h-100">
                    <div class="card-body text-center">
                        <h6 class="metric-label text-uppercase small">Sessions</h6>
                        <div id="totalSessionsValue" class="metric-value">0</div>
                    </div>
                </div>
            </div>
            <div class="col-lg col-md-6 col-sm-12 mb-3">
                <div class="card metric-card h-100">
                    <div class="card-body text-center">
                        <h6 class="metric-label text-uppercase small">Active Users</h6>
                        <div id="activeUsersValue" class="metric-value">0</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-lg-8 mb-3">
                <div class="card h-100">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>Daily Usage Trends</span>
                        <div class="btn-group btn-group-sm" role="group" id="dailyChartMetricToggle">
                            <button type="button" class="btn btn-outline-primary active" data-metric="tokens">Tokens</button>
                            <button type="button" class="btn btn-outline-primary" data-metric="cost">Cost</button>
                        </div>
                    </div>
                    <div class="card-body">
                         <div style="height: 300px;"><canvas id="dailyUsageChart"></canvas></div>
                    </div>
                </div>
            </div>
            <div class="col-lg-4 mb-3">
                <div class="card h-100">
                    <div class="card-header">Agent Conversation Distribution</div>
                    <div class="card-body">
                         <div style="height: 300px;"><canvas id="agentDistributionChart"></canvas></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header p-0">
                        <ul class="nav nav-tabs card-header-tabs" id="dataTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="user-tab" data-bs-toggle="tab" data-bs-target="#user-data" type="button" role="tab">User Activity</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="conversation-tab" data-bs-toggle="tab" data-bs-target="#conversation-data" type="button" role="tab">Traces</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="session-tab" data-bs-toggle="tab" data-bs-target="#session-data" type="button" role="tab">Sessions</button>
                            </li>
                             <li class="nav-item" role="presentation">
                                <button class="nav-link" id="agent-tab" data-bs-toggle="tab" data-bs-target="#agent-data" type="button" role="tab">Agent Summary</button>
                            </li>
                             <li class="nav-item" role="presentation">
                                <button class="nav-link" id="model-tab" data-bs-toggle="tab" data-bs-target="#model-data" type="button" role="tab">Model Usage</button>
                            </li>
                        </ul>
                    </div>
                    <div class="card-body">
                        <div id="tableLoadingIndicator" class="text-center py-5" style="display: none;">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Loading data...</p>
                        </div>

                        <div class="tab-content" id="dataTabsContent">
                            <div class="tab-pane fade show active" id="user-data" role="tabpanel">
                                <div class="table-responsive">
                                    <table class="table table-hover table-sm small" id="userTable">
                                        <thead>
                                            <tr>
                                                <th data-field="userId">User ID</th>
                                                <th data-field="totalTraces" class="text-end">Total Traces</th>
                                                <th data-field="agents" class="no-sort">Agents Used</th>
                                                <th data-field="firstSeen">First Seen</th>
                                                <th data-field="lastSeen">Last Seen</th>
                                                <th data-field="totalTokens" class="text-end">Total Tokens</th>
                                                <th data-field="totalCost" class="text-end">Total Cost ($)</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                                <div id="user-pagination"></div>
                            </div>

                            <div class="tab-pane fade" id="conversation-data" role="tabpanel">
                                <div class="table-responsive">
                                    <table class="table table-hover table-sm small" id="conversationTable">
                                        <thead>
                                            <tr>
                                                <th data-field="id">Trace ID</th>
                                                <th data-field="userId">User</th>
                                                <th data-field="agent">Agent</th>
                                                <th data-field="startTime">Start Time</th>
                                                <th data-field="endTime">End Time</th>
                                                <th data-field="messageCount" class="text-end">Observations</th>
                                                <th data-field="totalTokens" class="text-end">Tokens</th>
                                                <th data-field="totalCost" class="text-end">Cost ($)</th>
                                                <th class="no-sort text-center">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                                <div id="conversation-pagination"></div>
                            </div>

                            <div class="tab-pane fade" id="session-data" role="tabpanel">
                                <div class="table-responsive">
                                     <table class="table table-hover table-sm small" id="sessionTable">
                                        <thead>
                                            <tr>
                                                <th data-field="id">Session ID</th>
                                                <th data-field="userId">User</th>
                                                <th data-field="agent">Agent</th>
                                                <th data-field="startTime">Start Time</th>
                                                <th data-field="endTime">End Time</th>
                                                <th data-field="durationSeconds" class="text-end">Duration</th>
                                                <th data-field="traceCount" class="text-end">Traces</th>
                                                <th data-field="totalTokens" class="text-end">Tokens</th>
                                                <th data-field="totalCost" class="text-end">Cost ($)</th>
                                                <th class="no-sort text-center">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                                 <div id="session-pagination"></div>
                            </div>

                             <div class="tab-pane fade" id="agent-data" role="tabpanel">
                                <div class="table-responsive">
                                    <table class="table table-hover table-sm small" id="agentTable">
                                        <thead>
                                            <tr>
                                                <th data-field="agent">Agent</th>
                                                <th data-field="totalUsers" class="text-end">Total Users</th>
                                                <th data-field="countTraces" class="text-end">Total Traces</th>
                                                <th data-field="avgMessagesPerConv" class="text-end">Avg Obs/Trace</th>
                                                <th data-field="totalTokens" class="text-end">Total Tokens</th>
                                                <th data-field="totalCost" class="text-end">Total Cost ($)</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                                <div id="agent-pagination"></div>
                                </div>

                            <div class="tab-pane fade" id="model-data" role="tabpanel">
                                <div class="table-responsive">
                                    <table class="table table-hover table-sm small" id="modelTable">
                                        <thead>
                                            <tr>
                                                <th data-field="model" class="text-start">Model Name</th>
                                                <th data-field="observationCount" class="text-end">Observations</th>
                                                <th data-field="totalTokens" class="text-end">Total Tokens</th>
                                                <th data-field="totalCost" class="text-end">Total Cost ($)</th>
                                                </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                                <div id="model-pagination"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notifications Container -->
    <div class="toast-container"></div>

    <!-- Trace Graph Modal -->
    <div class="modal fade" id="traceGraphModal" tabindex="-1" aria-labelledby="traceGraphModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="traceGraphModalLabel">Token Usage by Observation</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="traceGraphLoading" class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p>Loading trace data...</p>
                    </div>
                    <div id="traceGraphContainer" style="display: none;">
                        <div style="height: 400px;">
                            <canvas id="traceGraph"></canvas>
                        </div>
                        <div id="traceGraphSummary" class="text-center mt-2 text-muted small"></div>
                        <div id="tokenTableContainer" class="mt-3" style="max-height: 200px; overflow-y: auto;"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // --- Global Variables ---
        let dailyUsageChart;
        let agentDistributionChart;
        let allData = {};
        let filteredData = {};
        let lastDataFetchTime = null;
        const ITEMS_PER_PAGE = 50;
        // ** Fix: Commented out base URL for Langfuse links **
        // const LANGFUSE_BASE_URL = 'https://your-langfuse-host.com'; // Replace with your Langfuse instance URL

        // Global state for sorting and pagination per table
        const tableState = {
            user: { sortField: 'lastSeen', sortDirection: 'desc', currentPage: 1 },
            conversation: { sortField: 'endTime', sortDirection: 'desc', currentPage: 1 },
            session: { sortField: 'endTime', sortDirection: 'desc', currentPage: 1 },
            agent: { sortField: 'totalCost', sortDirection: 'desc', currentPage: 1 },
            model: { sortField: 'totalCost', sortDirection: 'desc', currentPage: 1 },
        };
        
        // Theme handling - initialize with system preference or stored preference
        function initializeTheme() {
            const storedTheme = localStorage.getItem('dashboardTheme');
            
            // If user has already set a preference, use that
            if (storedTheme) {
                document.documentElement.setAttribute('data-theme', storedTheme);
                updateThemeIcon(storedTheme);
            } else {
                // Otherwise try to use system preference
                const prefersDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;
                const initialTheme = prefersDarkMode ? 'dark' : 'light';
                document.documentElement.setAttribute('data-theme', initialTheme);
                localStorage.setItem('dashboardTheme', initialTheme);
                updateThemeIcon(initialTheme);
            }
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            
            // Update DOM
            document.documentElement.setAttribute('data-theme', newTheme);
            
            // Save preference
            localStorage.setItem('dashboardTheme', newTheme);
            
            // Update icon
            updateThemeIcon(newTheme);
            
            // Update charts with new theme colors
            updateChartsForTheme();
        }

        function updateThemeIcon(theme) {
            const icon = document.querySelector('#themeToggle i');
            if (icon) {
                if (theme === 'dark') {
                    icon.className = 'fas fa-moon';
                } else {
                    icon.className = 'fas fa-sun';
                }
            }
        }

        function updateChartsForTheme() {
            // Only update if charts are initialized
            if (dailyUsageChart) {
                const currentTheme = document.documentElement.getAttribute('data-theme');
                const textColor = currentTheme === 'dark' ? '#e9ecef' : '#343a40';
                const gridColor = currentTheme === 'dark' ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
                
                // Update Daily Usage Chart
                dailyUsageChart.options.scales.x.grid.color = gridColor;
                dailyUsageChart.options.scales.y.grid.color = gridColor;
                dailyUsageChart.options.scales.x.ticks.color = textColor;
                dailyUsageChart.options.scales.y.ticks.color = textColor;
                dailyUsageChart.options.scales.x.title.color = textColor;
                dailyUsageChart.options.scales.y.title.color = textColor;
                dailyUsageChart.options.plugins.legend.labels.color = textColor;
                dailyUsageChart.update();
                
                // Update Agent Distribution Chart
                if (agentDistributionChart) {
                    agentDistributionChart.options.plugins.legend.labels.color = textColor;
                    agentDistributionChart.update();
                }
            }
        }

        // Langfuse configuration - will be set from environment variables
        const LANGFUSE_CONFIG = {
            host: window.LANGFUSE_HOST || 'langfuse.zoomrx.ai',
            projectIds: {
                // Agent-specific project IDs from environment variables
                HCP_P: window.HCP_P_PROJECT_ID || '',
                SCOPING: window.SCOPING_PROJECT_ID || '',
                SYNAPSE: window.SYNAPSE_PROJECT_ID || '',
                HASHTAG: window.HASHTAG_PROJECT_ID || '',
                SURVEY_CODING: window.SURVEY_CODING_PROJECT_ID || '',
            }
        };

        // Log the loaded configuration values for debugging
        console.log('Langfuse configuration:', LANGFUSE_CONFIG);

        // Function to generate Langfuse URL for traces
        function getLangfuseTraceUrl(traceId, agent) {
            // Get the project ID for the agent, or use default if not found
            const agentKey = agent ? agent.toUpperCase().replace(/[^A-Z0-9_]/g, '_') : '';
            const projectId = LANGFUSE_CONFIG.projectIds[agentKey] || LANGFUSE_CONFIG.projectIds.default;

            if (!projectId) {
                console.error(`No project ID found for agent: ${agent}`);
                return '#'; // Return hash if no project ID found
            }

            // Ensure host doesn't have https:// prefix (it will be added below)
            const host = LANGFUSE_CONFIG.host.replace(/^https?:\/\//, '');

            // Use the correct format: host/project/projectId/traces?peek=traceId
            return `https://${host}/project/${projectId}/traces?peek=${traceId}`;
        }

        // Function to generate Langfuse URL for sessions
        function getLangfuseSessionUrl(sessionId, agent) {
            // Get the project ID for the agent, or use default if not found
            const agentKey = agent ? agent.toUpperCase().replace(/[^A-Z0-9_]/g, '_') : '';
            const projectId = LANGFUSE_CONFIG.projectIds[agentKey] || LANGFUSE_CONFIG.projectIds.default;

            if (!projectId) {
                console.error(`No project ID found for agent: ${agent}`);
                return '#'; // Return hash if no project ID found
            }

            // Ensure host doesn't have https:// prefix (it will be added below)
            const host = LANGFUSE_CONFIG.host.replace(/^https?:\/\//, '');

            // Use the correct format: host/project/projectId/sessions/sessionId
            return `https://${host}/project/${projectId}/sessions/${sessionId}`;
        }

        // Function to generate Langfuse URL for observations
        function getLangfuseObservationUrl(observationId, agent, timestamp) {
            // Get the project ID for the agent, or use default if not found
            const agentKey = agent ? agent.toUpperCase().replace(/[^A-Z0-9_]/g, '_') : '';
            const projectId = LANGFUSE_CONFIG.projectIds[agentKey] || LANGFUSE_CONFIG.projectIds.default;

            if (!projectId) {
                console.error(`No project ID found for agent: ${agent}`);
                return '#'; // Return hash if no project ID found
            }

            // Ensure host doesn't have https:// prefix (it will be added below)
            const host = LANGFUSE_CONFIG.host.replace(/^https?:\/\//, '');

            // Use the timestamp if available, otherwise use current time
            const encodedTimestamp = timestamp ? 
                encodeURIComponent(moment(timestamp).toISOString()) : 
                encodeURIComponent(new Date().toISOString());

            // Use the correct format: host/project/projectId/observations?observation=observationId&peek=observationId&timestamp=timestamp
            return `https://${host}/project/${projectId}/observations?observation=${observationId}&peek=${observationId}&timestamp=${encodedTimestamp}`;
        }

        // --- Utility Functions ---
        function formatNumber(num) { return (num || 0).toLocaleString(); }
        function formatCost(num) { return '$' + (num || 0).toFixed(4); }
        function formatDuration(seconds) {
            if (seconds === null || seconds === undefined || seconds < 0) return '-';
            seconds = Math.round(seconds);
            if (seconds < 60) return `${seconds}s`;
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            if (minutes < 60) return `${minutes}m ${remainingSeconds}s`;
            const hours = Math.floor(minutes / 60);
            const remainingMinutes = minutes % 60;
            return `${hours}h ${remainingMinutes}m ${remainingSeconds}s`;
        }
        function formatDate(dateString, format = 'YYYY-MM-DD') {
             if (!dateString) return '-';
             const date = moment.utc(dateString);
             return date.isValid() ? date.local().format(format) : '-';
        }
         function formatDateTime(dateString, format = 'YYYY-MM-DD HH:mm:ss') {
             if (!dateString) return '-';
             const date = moment.utc(dateString);
             return date.isValid() ? date.local().format(format) : '-';
        }
        function getAgentBadgeClass(agentName) {
            if (!agentName) return 'agent-unknown';
            const className = `agent-${agentName.toLowerCase().replace(/[^a-z0-9]+/g, '_')}`;
            const knownClasses = ['agent-hcp_p', 'agent-scoping', 'agent-synapse', 'agent-hashtag', 'agent-survey_coding', 'agent-unknown'];
            if (knownClasses.includes(className)) return className;
            return 'agent-default';
        }
        async function fetchJson(url) { /* ... (fetchJson remains the same) ... */
             try {
                const response = await fetch(`${url}?t=${new Date().getTime()}`); // Cache bust
                if (!response.ok) {
                    console.error(`HTTP error fetching ${url}: ${response.status} ${response.statusText}`);
                     let errorBody = '';
                    try { errorBody = await response.text(); } catch (e) { /* ignore */}
                    console.error("Error response body:", errorBody);
                    throw new Error(`HTTP error ${response.status}`);
                }
                const contentType = response.headers.get("content-type");
                if (contentType && contentType.includes("application/json")) {
                     return await response.json();
                } else {
                     console.warn(`Received non-JSON response from ${url}. Content-Type: ${contentType}. Returning empty.`);
                     if (url.includes('daily') || url.includes('agent') || url.includes('user') || url.includes('conversation') || url.includes('session') || url.includes('model')) return [];
                     return {};
                 }
            } catch (error) {
                console.error(`Error fetching or parsing ${url}:`, error);
                 if (url.includes('daily') || url.includes('agent') || url.includes('user') || url.includes('conversation') || url.includes('session') || url.includes('model')) return [];
                 return {};
            }
         }
        function logFrontendEvent(message) { console.log("FE Log:", message); }
        function showLoading(tabId = null) { /* ... (showLoading remains the same) ... */
              $('#tableLoadingIndicator').show();
             if (tabId) $(`#${tabId} tbody`).hide();
        }
        function hideLoading(tabId = null) { /* ... (hideLoading remains the same) ... */
             $('#tableLoadingIndicator').hide();
             if (tabId) $(`#${tabId} tbody`).show();
        }

        // --- Data Loading and Processing ---
        async function loadAllData() { /* ... (loadAllData remains mostly the same, parsing logic updated slightly if needed) ... */
             showLoading();
            logFrontendEvent("Initiating data load...");
            const dataFiles = [
                'all_daily_metrics.json', 'all_traces.json', 'all_sessions.json',
                'user_metrics.json', 'agent_comparison.json', 'model_token_usage.json'
            ];
            const promises = dataFiles.map(file => fetchJson(`/dashboard_data/${file}`));
            try {
                const results = await Promise.all(promises);
                allData = {
                    dailyMetrics: results[0] || [],
                    traces: results[1] || [],
                    sessions: results[2] || [],
                    userMetrics: results[3] || [],
                    agentComparison: results[4] || [],
                    modelUsage: results[5] || [],
                };
                // Reset lastDataFetchTime to ensure we use the current time
                lastDataFetchTime = new Date();
                
                // Debug log for agent comparison data
                console.log("Loaded agent comparison data:", allData.agentComparison);
                
                logFrontendEvent(`Data loaded: ${allData.traces?.length} traces, ${allData.sessions?.length} sessions.`);
                 const parseDates = (items, dateFields) => {
                    if (!Array.isArray(items)) return;
                    items.forEach(item => {
                         dateFields.forEach(field => {
                            if (item[field] && typeof item[field] === 'string') {
                                item[field] = moment.utc(item[field]).toDate();
                            } else if (item[field] && !(item[field] instanceof Date)) {
                                const parsed = moment.utc(item[field]);
                                item[field] = parsed.isValid() ? parsed.toDate() : null;
                                if (!item[field]) console.warn(`Could not parse date field '${field}'`, item[field]);
                            }
                         });
                    });
                };
                parseDates(allData.traces, ['timestamp', 'startTime', 'endTime']);
                parseDates(allData.sessions, ['createdAt', 'startTime', 'endTime']);
                parseDates(allData.userMetrics, ['firstSeen', 'lastSeen']);
                populateAgentFilter();
                populateUserFilter();
                applyFiltersAndRefresh();
                updateLastDataFetch(true); // Set to true to update with current time
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                alert('Failed to load dashboard data. Check console and data files.');
                updateLastDataFetch(false);
            } finally {
                 hideLoading();
            }
        }
        function populateAgentFilter() { /* ... (populateAgentFilter remains the same) ... */
             const agentSelect = $('#agentFilter');
            const agents = [...new Set(allData.agentComparison?.map(a => a.agent) ?? [])].sort();
            agentSelect.find('option:not(:first)').remove();
            agents.forEach(agent => {
                agentSelect.append($('<option>', { value: agent, text: agent }));
            });
            logFrontendEvent(`Populated agent filter: ${agents.length} agents.`);
        }
        function populateUserFilter() { /* ... (populateUserFilter remains the same) ... */
            const userSelect = $('#userFilter');
            const selectedAgent = $('#agentFilter').val();
            let users = [];
            if (selectedAgent === 'all') {
                users = [...new Set(allData.userMetrics?.map(u => u.userId) ?? [])].sort();
            } else {
                users = [...new Set(
                    allData.userMetrics
                        ?.filter(u => u.agents && u.agents.includes(selectedAgent))
                        .map(u => u.userId) ?? []
                )].sort();
            }
            const currentVal = userSelect.val();
            userSelect.find('option:not(:first)').remove();
            users.forEach(userId => {
                userSelect.append($('<option>', { value: userId, text: userId }));
            });
            if (users.includes(currentVal)) userSelect.val(currentVal);
            else userSelect.val('all');
            logFrontendEvent(`Populated user filter for agent '${selectedAgent}': ${users.length} users.`);
        }
        function applyFiltersAndRefresh() { /* ... (applyFiltersAndRefresh remains the same) ... */
            logFrontendEvent("Applying filters and refreshing dashboard...");
            const agentFilter = $('#agentFilter').val();
            const userFilter = $('#userFilter').val();
            const dateRange = $('#dateRangeFilter').data('daterangepicker');
             if (!dateRange) {
                 logFrontendEvent("Date range picker not initialized yet. Skipping filter.");
                 return;
             }
            const startDate = dateRange.startDate.startOf('day').toDate();
            const endDate = dateRange.endDate.endOf('day').toDate();
             filteredData = {};
            const startDateStr = moment(startDate).format('YYYY-MM-DD');
            const endDateStr = moment(endDate).format('YYYY-MM-DD');
            filteredData.dailyMetrics = allData.dailyMetrics?.filter(m =>
                 m.date >= startDateStr && m.date <= endDateStr &&
                 (agentFilter === 'all' || m.agent === agentFilter)
             ) ?? [];
             filteredData.traces = allData.traces?.filter(t => {
                 const traceTime = (t.endTime instanceof Date && !isNaN(t.endTime)) ? t.endTime :
                                  (t.startTime instanceof Date && !isNaN(t.startTime)) ? t.startTime :
                                  (t.timestamp instanceof Date && !isNaN(t.timestamp)) ? t.timestamp : null;
                 return traceTime && traceTime >= startDate && traceTime <= endDate &&
                        (agentFilter === 'all' || t.agent === agentFilter) &&
                        (userFilter === 'all' || t.userId === userFilter);
             }) ?? [];
              filteredData.sessions = allData.sessions?.filter(s => {
                 const sessionTime = (s.endTime instanceof Date && !isNaN(s.endTime)) ? s.endTime :
                                     (s.createdAt instanceof Date && !isNaN(s.createdAt)) ? s.createdAt : null;
                 return sessionTime && sessionTime >= startDate && sessionTime <= endDate &&
                        (agentFilter === 'all' || s.agent === agentFilter) &&
                        (userFilter === 'all' || s.userId === userFilter);
             }) ?? [];
              filteredData.userMetrics = allData.userMetrics?.filter(u => {
                   const lastSeen = (u.lastSeen instanceof Date && !isNaN(u.lastSeen)) ? u.lastSeen : null;
                   return lastSeen && lastSeen >= startDate && lastSeen <= endDate &&
                          (userFilter === 'all' || u.userId === userFilter) &&
                          (agentFilter === 'all' || (u.agents && u.agents.includes(agentFilter)))
              }) ?? [];
             filteredData.modelUsage = aggregateModelUsage(filteredData.traces, filteredData.sessions);
             
             // Add agent comparison filtering
             filteredData.agentComparison = agentFilter === 'all' 
                ? allData.agentComparison ?? []
                : allData.agentComparison?.filter(a => a.agent === agentFilter) ?? [];
                
             logFrontendEvent(`Filtering complete: ${filteredData.traces?.length} traces, ${filteredData.sessions?.length} sessions remain.`);
             updateDashboard();
        }
        function aggregateModelUsage(filteredTraces, filteredSessions) { /* ... (aggregateModelUsage remains the same, returning unfiltered data) ... */
            console.warn("Model Usage tab currently shows overall usage, not filtered by agent/user.");
            return allData.modelUsage ?? [];
         }

        // --- UI Update Functions ---
        function updateDashboard() { /* ... (updateDashboard remains the same) ... */
              logFrontendEvent("Updating dashboard UI...");
            updateSummaryMetrics();
            updateCharts();
            updateActiveTable();
         }
        function updateSummaryMetrics() { /* ... (updateSummaryMetrics remains the same) ... */
             let totalTokens = 0;
            let totalCost = 0.0;
            filteredData.traces?.forEach(trace => {
                totalTokens += trace.totalTokens || 0;
                totalCost += trace.totalCost || 0.0;
            });
            const totalConversations = filteredData.traces?.length ?? 0;
            const totalSessions = filteredData.sessions?.length ?? 0;
            const activeUsers = new Set(filteredData.traces?.map(t => t.userId).filter(Boolean)).size;
            $('#totalTokensValue').text(formatNumber(totalTokens));
            $('#totalCostValue').text(formatCost(totalCost));
            $('#totalConversationsValue').text(formatNumber(totalConversations));
            $('#totalSessionsValue').text(formatNumber(totalSessions));
            $('#activeUsersValue').text(formatNumber(activeUsers));
        }
        function updateCharts() { /* ... (updateCharts remains the same) ... */
             updateDailyUsageChart();
            updateAgentDistributionChart();
        }

        // --- Chart Initialization and Updates ---
        function initializeCharts() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const textColor = currentTheme === 'dark' ? '#e9ecef' : '#343a40';
            const gridColor = currentTheme === 'dark' ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
            
            const dailyCtx = document.getElementById('dailyUsageChart').getContext('2d');
            dailyUsageChart = new Chart(dailyCtx, {
                type: 'line',
                data: { labels: [], datasets: [] },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    interaction: { mode: 'index', intersect: false }, 
                    plugins: { 
                        legend: { 
                            position: 'bottom',
                            labels: {
                                color: textColor
                            }
                        }, 
                        tooltip: { 
                            callbacks: {
                                label: function(context) { 
                                    let label = context.dataset.label || ''; 
                                    if (label) label += ': '; 
                                    const value = context.parsed.y; 
                                    const metricType = $('#dailyChartMetricToggle .active').data('metric') || 'tokens'; 
                                    if (value !== null) 
                                        label += metricType === 'cost' ? formatCost(value) : formatNumber(value); 
                                    return label; 
                                }
                            }
                        }
                    }, 
                    scales: { 
                        x: { 
                            grid: { 
                                display: true,
                                color: gridColor
                            },
                            ticks: {
                                color: textColor
                            },
                            title: {
                                display: true,
                                text: 'Date',
                                color: textColor
                            }
                        }, 
                        y: { 
                            beginAtZero: true, 
                            grid: {
                                color: gridColor
                            },
                            ticks: { 
                                color: textColor,
                                callback: function(value) { 
                                    const metricType = $('#dailyChartMetricToggle .active').data('metric') || 'tokens'; 
                                    return metricType === 'cost' ? '$' + formatNumber(Math.round(value)) : formatNumber(value); 
                                }
                            }, 
                            title: { 
                                display: true, 
                                text: 'Usage',
                                color: textColor
                            } 
                        } 
                    } 
                }
            });
            
            const agentCtx = document.getElementById('agentDistributionChart').getContext('2d');
            const agentColors = { 'HCP_P': '#8ac926', 'SCOPING': '#1982c4', 'SYNAPSE': '#6a4c93', 'HASHTAG': '#ff595e', 'SURVEY_CODING': '#ffca3a', 'DEFAULT': '#6c757d' };
            
            agentDistributionChart = new Chart(agentCtx, {
                type: 'doughnut', 
                data: { 
                    labels: [], 
                    datasets: [{ 
                        data: [], 
                        backgroundColor: [], 
                        borderWidth: 1, 
                        borderColor: currentTheme === 'dark' ? '#272a30' : '#fff' 
                    }] 
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { 
                        legend: { 
                            position: 'right', 
                            labels: { 
                                boxWidth: 12,
                                color: textColor
                            } 
                        }, 
                        tooltip: { 
                            callbacks: {
                                label: function(context) { 
                                    let label = context.label || ''; 
                                    if (label) label += ': '; 
                                    const value = context.parsed; 
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0); 
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) + '%' : '0%'; 
                                    if (value !== null) label += formatNumber(value) + ` (${percentage})`; 
                                    return label; 
                                }
                            }
                        }
                    }, 
                    cutout: '65%' 
                }
            });
        }
        function updateDailyUsageChart() { /* ... (updateDailyUsageChart remains the same) ... */
             const metricType = $('#dailyChartMetricToggle .active').data('metric') || 'tokens';
            const sourceData = filteredData.dailyMetrics ?? [];
            const aggregated = {};
            const agents = new Set(sourceData.map(item => item.agent));
            sourceData.forEach(item => { const date = item.date; const agent = item.agent; if (!aggregated[date]) aggregated[date] = { date: date }; const value = metricType === 'cost' ? (item.totalCost || 0) : (item.totalTokens || 0); aggregated[date][agent] = (aggregated[date][agent] || 0) + value; });
            const sortedDates = Object.keys(aggregated).sort();
            const labels = sortedDates.map(date => formatDate(date, 'MMM D'));
            const agentColors = { 'HCP_P': '#8ac926', 'SCOPING': '#1982c4', 'SYNAPSE': '#6a4c93', 'HASHTAG': '#ff595e', 'SURVEY_CODING': '#ffca3a', 'DEFAULT': '#6c757d' };
             const datasets = Array.from(agents).sort().map(agent => { const colorKey = agent.toUpperCase().replace(/[^A-Z0-9]+/g, '_'); const color = agentColors[colorKey] || agentColors['DEFAULT']; return { label: agent, data: sortedDates.map(date => aggregated[date][agent] || 0), borderColor: color, backgroundColor: color + '33', borderWidth: 1.5, tension: 0.1, pointRadius: 1, pointHoverRadius: 4, fill: true }; });
            dailyUsageChart.data.labels = labels;
            dailyUsageChart.data.datasets = datasets;
            dailyUsageChart.options.scales.y.title.text = metricType === 'cost' ? 'Cost (USD)' : 'Tokens';
             dailyUsageChart.options.scales.y.ticks.callback = function(value) { return metricType === 'cost' ? '$' + formatNumber(Math.round(value)) : formatNumber(value); };
            dailyUsageChart.update();
        }
        function updateAgentDistributionChart() { /* ... (updateAgentDistributionChart remains the same) ... */
            const agentCounts = {};
            filteredData.traces?.forEach(trace => { const agent = trace.agent || 'Unknown'; agentCounts[agent] = (agentCounts[agent] || 0) + 1; });
            const sortedAgents = Object.entries(agentCounts).sort(([, countA], [, countB]) => countB - countA);
            const labels = sortedAgents.map(([agent]) => agent);
            const data = sortedAgents.map(([, count]) => count);
            const agentColors = { 'HCP_P': '#8ac926', 'SCOPING': '#1982c4', 'SYNAPSE': '#6a4c93', 'HASHTAG': '#ff595e', 'SURVEY_CODING': '#ffca3a', 'DEFAULT': '#6c757d' };
             const backgroundColors = labels.map(label => { const colorKey = label.toUpperCase().replace(/[^A-Z0-9]+/g, '_'); return agentColors[colorKey] || agentColors['DEFAULT']; });
            agentDistributionChart.data.labels = labels;
            agentDistributionChart.data.datasets[0].data = data;
            agentDistributionChart.data.datasets[0].backgroundColor = backgroundColors;
            agentDistributionChart.update();
        }

        // --- Table Rendering ---
        function renderTable(tableId, data, columns, stateKey) { /* ... (renderTable remains the same) ... */
              const tableBody = $(`#${tableId} tbody`);
             const paginationContainer = $(`#${stateKey}-pagination`);
             if (!tableBody.length || !paginationContainer.length) return;
             tableBody.empty(); paginationContainer.empty();
             if (!data || data.length === 0) { tableBody.html(`<tr><td colspan="${columns.length}" class="text-center text-muted py-4">No data available for the selected filters.</td></tr>`); return; }
             let sortedData = [...data];
            const { sortField, sortDirection } = tableState[stateKey];
            if (sortField) sortedData = sortData(sortedData, sortField, sortDirection);
            const { currentPage } = tableState[stateKey];
            const totalItems = sortedData.length;
             const paginatedData = sortedData.slice((currentPage - 1) * ITEMS_PER_PAGE, currentPage * ITEMS_PER_PAGE);
             paginatedData.forEach(item => {
                 const row = $('<tr>');
                 columns.forEach(column => {
                     const cell = $('<td>').html(column.render(item));
                      if (column.cellClass) { const classes = typeof column.cellClass === 'function' ? column.cellClass(item) : column.cellClass; if (classes) cell.addClass(classes); }
                     row.append(cell);
                 });
                 tableBody.append(row);
             });
             setupPagination(paginationContainer.attr('id'), stateKey, totalItems, ITEMS_PER_PAGE, (newPage) => { tableState[stateKey].currentPage = newPage; renderTable(tableId, data, columns, stateKey); });
         }

        // Define columns for each table
        const userColumns = [ /* ... (userColumns remain the same) ... */
             { header: 'User ID', field: 'userId', render: item => item.userId || 'Unknown', cellClass: 'text-break' },
             { header: 'Total Traces', field: 'totalTraces', render: item => formatNumber(item.totalTraces), cellClass: 'text-end' },
             { header: 'Agents Used', field: 'agents', sortable: false, render: item => (item.agents || []).map(agent => `<span class="badge badge-agent ${getAgentBadgeClass(agent)} me-1">${agent}</span>`).join(' ') },
             { header: 'First Seen', field: 'firstSeen', render: item => formatDateTime(item.firstSeen) },
             { header: 'Last Seen', field: 'lastSeen', render: item => formatDateTime(item.lastSeen) },
             { header: 'Total Tokens', field: 'totalTokens', render: item => formatNumber(item.totalTokens), cellClass: 'text-end' },
             { header: 'Total Cost ($)', field: 'totalCost', render: item => formatCost(item.totalCost), cellClass: 'text-end' },
         ];
        const conversationColumns = [
             { header: 'Trace ID', field: 'id', render: item => {
                // Show shortened trace ID with hover for full ID
                if (!item.id) return '-';
                const shortId = item.id.substring(0, 8) + '...';
                return `<span title="${item.id}">${shortId}</span>`;
             }, cellClass: 'text-break' },
             { header: 'User', field: 'userId', render: item => item.userId || 'Unknown' },
             { header: 'Agent', field: 'agent', render: item => `<span class="badge badge-agent ${getAgentBadgeClass(item.agent)}">${item.agent || 'Unknown'}</span>` },
             { header: 'Start Time', field: 'startTime', render: item => formatDateTime(item.startTime) },
             { header: 'End Time', field: 'endTime', render: item => formatDateTime(item.endTime) },
             { header: 'Observations', field: 'messageCount', render: item => formatNumber(item.messageCount), cellClass: 'text-center' },
             { header: 'Tokens', field: 'totalTokens', render: item => formatNumber(item.totalTokens), cellClass: 'text-end' },
             { header: 'Cost ($)', field: 'totalCost', render: item => formatCost(item.totalCost), cellClass: 'text-end' },
             { header: 'Actions', field: '', sortable: false, headerClass: 'text-center', render: item => {
                if (!item.id) return '';
                const graphButton = `<button class="btn btn-sm btn-outline-primary view-trace-graph m-1" data-trace-id="${item.id}">View Graph</button>`;
                const langfuseLink = `<a href="${getLangfuseTraceUrl(item.id, item.agent)}" class="btn btn-sm btn-outline-secondary langfuse-btn m-1" target="_blank" title="View complete trace in Langfuse">Langfuse</a>`;
                return `<div class="d-flex justify-content-center">${graphButton}${langfuseLink}</div>`;
             }, cellClass: 'text-center' }
         ];
        const sessionColumns = [
            // ** Enhancement: Session ID Link (COMMENTED OUT) **
             // { header: 'Session ID', field: 'id', render: item => item.id ? `<a href="${LANGFUSE_BASE_URL}/project/${item.projectId}/sessions/${item.id}" target="_blank" title="${item.id}">${item.id.substring(0, 8)}...</a>` : '-', cellClass: 'text-break' },
             { header: 'Session ID', field: 'id', render: item => {
                // Show shortened session ID with hover for full ID
                if (!item.id) return '-';
                const shortId = item.id.substring(0, 8) + '...';
                return `<span title="${item.id}">${shortId}</span>`;
             }, cellClass: 'text-break' },
             { header: 'User', field: 'userId', render: item => item.userId || 'Unknown' },
             { header: 'Agent', field: 'agent', render: item => `<span class="badge badge-agent ${getAgentBadgeClass(item.agent)}">${item.agent || 'Unknown'}</span>` },
             { header: 'Start Time', field: 'startTime', render: item => formatDateTime(item.startTime) },
             { header: 'End Time', field: 'endTime', render: item => formatDateTime(item.endTime) },
             { header: 'Duration', field: 'durationSeconds', render: item => formatDuration(item.durationSeconds), cellClass: 'text-end', title: 'Sum of all operation latencies within the session' },
             { header: 'Traces', field: 'traceCount', render: item => formatNumber(item.traceCount), cellClass: 'text-center' },
             { header: 'Tokens', field: 'totalTokens', render: item => formatNumber(item.totalTokens), cellClass: 'text-end' },
             { header: 'Cost ($)', field: 'totalCost', render: item => formatCost(item.totalCost), cellClass: 'text-end' },
             { header: 'Actions', field: '', sortable: false, headerClass: 'text-center', render: item => {
                if (!item.id) return '';
                const langfuseLink = `<a href="${getLangfuseSessionUrl(item.id, item.agent)}" class="btn btn-sm btn-outline-secondary langfuse-btn m-1" target="_blank" title="View complete session in Langfuse">Langfuse</a>`;
                return `<div class="d-flex justify-content-center">${langfuseLink}</div>`;
             }, cellClass: 'text-center' }
         ];
         const agentColumns = [ /* ... (agentColumns remain the same) ... */
             { header: 'Agent', field: 'agent', render: item => `<span class="badge badge-agent ${getAgentBadgeClass(item.agent)} me-1">${item.agent}</span>` },
             { header: 'Total Users', field: 'totalUsers', render: item => formatNumber(item.totalUsers), cellClass: 'text-end' },
             { header: 'Total Traces', field: 'countTraces', render: item => formatNumber(item.countTraces), cellClass: 'text-end' },
             { header: 'Avg Obs/Trace', field: 'avgMessagesPerConv', render: item => item.avgMessagesPerConv?.toFixed(1) ?? '-', cellClass: 'text-end' },
             { header: 'Total Tokens', field: 'totalTokens', render: item => formatNumber(item.totalTokens), cellClass: 'text-end' },
             { header: 'Total Cost ($)', field: 'totalCost', render: item => formatCost(item.totalCost), cellClass: 'text-end' },
         ];
         const modelColumns = [ /* ... (modelColumns remain the same) ... */
             { header: 'Model Name', field: 'model', render: item => item.model || 'Unknown', cellClass: 'text-start' },
             { header: 'Observations', field: 'observationCount', render: item => formatNumber(item.observationCount), cellClass: 'text-end' },
             { header: 'Total Tokens', field: 'totalTokens', render: item => formatNumber(item.totalTokens), cellClass: 'text-end' },
             { header: 'Total Cost ($)', field: 'totalCost', render: item => formatCost(item.totalCost), cellClass: 'text-end' },
         ];

        // Update tables based on the currently active tab
         function updateActiveTable() { /* ... (updateActiveTable remains the same) ... */
              const activeTabButton = $('#dataTabs .nav-link.active');
             if (!activeTabButton.length) return;
             const targetPaneId = activeTabButton.attr('data-bs-target');
             switch (targetPaneId) {
                 case '#user-data': renderTable('userTable', filteredData.userMetrics, userColumns, 'user'); break;
                 case '#conversation-data': renderTable('conversationTable', filteredData.traces, conversationColumns, 'conversation'); break;
                 case '#session-data': renderTable('sessionTable', filteredData.sessions, sessionColumns, 'session'); break;
                 case '#agent-data': 
                     console.log("Rendering agent table with data:", filteredData.agentComparison); 
                     renderTable('agentTable', filteredData.agentComparison, agentColumns, 'agent'); 
                     break;
                 case '#model-data': renderTable('modelTable', filteredData.modelUsage, modelColumns, 'model'); break;
             }
          }

        // --- Sorting and Pagination Utilities ---
        function sortData(data, field, direction = 'asc') { /* ... (sortData remains the same) ... */
             return [...data].sort((a, b) => {
                let aVal = a[field]; let bVal = b[field];
                 if (aVal instanceof Date && bVal instanceof Date) { aVal = aVal.getTime(); bVal = bVal.getTime(); }
                 const aIsNull = aVal === null || aVal === undefined; const bIsNull = bVal === null || bVal === undefined;
                 if (aIsNull && bIsNull) return 0; if (aIsNull) return direction === 'asc' ? -1 : 1; if (bIsNull) return direction === 'asc' ? 1 : -1;
                 if (typeof aVal === 'string' && typeof bVal === 'string') { aVal = aVal.toLowerCase(); bVal = bVal.toLowerCase(); }
                 else if (Array.isArray(aVal) && Array.isArray(bVal)) { aVal = aVal.length; bVal = bVal.length; }
                if (aVal < bVal) return direction === 'asc' ? -1 : 1; if (aVal > bVal) return direction === 'asc' ? 1 : -1; return 0;
            });
         }
        function setupTableSorting(tableId, stateKey, columns) {
            const table = document.getElementById(tableId); 
            if (!table) return;
            
            const headers = table.querySelectorAll('thead th[data-field]');
            headers.forEach(header => {
                // Apply headerClass if defined for this column
                const columnDef = columns.find(c => c.field === header.dataset.field);
                if (columnDef && columnDef.headerClass) {
                    header.className += ` ${columnDef.headerClass}`;
                }
                
                // Skip if column is not sortable
                if (columnDef && columnDef.sortable === false) {
                    header.style.cursor = 'default';
                    return;
                }
                
                // Set up sorting
                header.style.cursor = 'pointer';
                header.addEventListener('click', () => {
                    const field = header.dataset.field;
                    let newDir = 'asc';
                    
                    table.querySelectorAll('thead th[data-field]').forEach(h => h.classList.remove('sorting-asc', 'sorting-desc'));
                    
                    if (tableState[stateKey].sortField === field) {
                        newDir = tableState[stateKey].sortDirection === 'asc' ? 'desc' : 'asc';
                    }
                    
                    tableState[stateKey].sortField = field;
                    tableState[stateKey].sortDirection = newDir;
                    tableState[stateKey].currentPage = 1;
                    
                    header.classList.add(newDir === 'asc' ? 'sorting-asc' : 'sorting-desc');
                    logFrontendEvent(`Sorting table ${tableId} by ${field} (${newDir})`);
                    updateActiveTable();
                });
                
                if (tableState[stateKey].sortField === header.dataset.field) {
                    header.classList.add(tableState[stateKey].sortDirection === 'asc' ? 'sorting-asc' : 'sorting-desc');
                }
            });
        }
        function setupPagination(containerId, stateKey, totalItems, itemsPerPage, onPageChange) { /* ... (setupPagination remains the same) ... */
              const container = $(`#${containerId}`); container.empty(); if (totalItems <= itemsPerPage) return;
            const template = $('#paginationTemplate'); const paginationControls = $(template.html());
            const totalPages = Math.ceil(totalItems / itemsPerPage); const currentPage = tableState[stateKey].currentPage;
            const startItem = (currentPage - 1) * itemsPerPage + 1; const endItem = Math.min(startItem + itemsPerPage - 1, totalItems);
            paginationControls.find('.showing-start').text(formatNumber(startItem)); paginationControls.find('.showing-end').text(formatNumber(endItem)); paginationControls.find('.total-items').text(formatNumber(totalItems));
            const prevBtn = paginationControls.find('.prev-page'); const nextBtn = paginationControls.find('.next-page');
            prevBtn.prop('disabled', currentPage === 1); nextBtn.prop('disabled', currentPage === totalPages);
            prevBtn.on('click', () => onPageChange(currentPage - 1)); nextBtn.on('click', () => onPageChange(currentPage + 1));
            container.append(paginationControls);
         }

        // --- Event Listeners ---
        function initializeDateRangePicker() { /* ... (initializeDateRangePicker remains the same) ... */
             $('#dateRangeFilter').daterangepicker({
                startDate: moment().subtract(7, 'days'), // Changed from 30 days to 7 days as default
                endDate: moment(), 
                opens: 'left', 
                locale: { 
                    format: 'MMM D, YYYY', // Changed date format to show month name, day and year
                    applyLabel: 'Apply',
                    cancelLabel: 'Cancel',
                    customRangeLabel: 'Custom Range'
                },
                ranges: { 
                    'Today': [moment(), moment()], 
                    'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')], 
                    'Last 24 Hours': [moment().subtract(24, 'hours'), moment()],
                    'Last 3 Days': [moment().subtract(2, 'days'), moment()], 
                    'Last 7 Days': [moment().subtract(6, 'days'), moment()], 
                    'Last 14 Days': [moment().subtract(13, 'days'), moment()],
                    'Last 30 Days': [moment().subtract(29, 'days'), moment()], 
                    'This Month': [moment().startOf('month'), moment().endOf('month')], 
                    'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
                }
            }, function(start, end, label) { 
                logFrontendEvent(`Date range changed: ${start.format('YYYY-MM-DD')} to ${end.format('YYYY-MM-DD')}`); 
                applyFiltersAndRefresh(); 
            });
            
            // Add event listeners for quick date presets
            $('.date-preset').on('click', function() {
                const days = parseInt($(this).data('days'), 10);
                const endDate = moment();
                const startDate = moment().subtract(days - 1, 'days');
                
                // Remove active class from all buttons and add to the clicked one
                $('.date-preset').removeClass('active');
                $(this).addClass('active');
                
                $('#dateRangeFilter').data('daterangepicker').setStartDate(startDate);
                $('#dateRangeFilter').data('daterangepicker').setEndDate(endDate);
                
                logFrontendEvent(`Quick date filter set to ${days} days`);
                applyFiltersAndRefresh();
            });
            
            // Set default active button (7 days)
            $('.date-preset[data-days="7"]').addClass('active');
            
            // Update button active state when date range changes from the picker
            $('#dateRangeFilter').on('apply.daterangepicker', function(ev, picker) {
                // Calculate the number of days in the range
                const start = picker.startDate;
                const end = picker.endDate;
                const days = end.diff(start, 'days') + 1;
                
                // Clear all active states
                $('.date-preset').removeClass('active');
                
                // If the range matches one of our presets, highlight that button
                $('.date-preset').each(function() {
                    const presetDays = parseInt($(this).data('days'), 10);
                    if (presetDays === days && end.isSame(moment(), 'day')) {
                        $(this).addClass('active');
                    }
                });
            });
         }
        function updateLastDataFetch(success = true) {
            const display = $('#lastDataFetch');
            const now = new Date();
            
            if (success) {
                lastDataFetchTime = now;
                localStorage.setItem('dashboardLastDataFetch', lastDataFetchTime.toISOString());
            } else if (lastDataFetchTime === null) {
                const storedTime = localStorage.getItem('dashboardLastDataFetch');
                if (storedTime) {
                    const parsedTime = new Date(storedTime);
                    // Only use stored time if it's less than 12 hours old, otherwise reset it
                    if (!isNaN(parsedTime) && (now - parsedTime) < 12 * 60 * 60 * 1000) {
                        lastDataFetchTime = parsedTime;
                    } else {
                        localStorage.removeItem('dashboardLastDataFetch');
                    }
                }
            }
            
            if (lastDataFetchTime) {
                display.text(`Data last refreshed: ${moment(lastDataFetchTime).fromNow()}`);
                display.attr('title', lastDataFetchTime.toLocaleString());
                display.removeClass('text-danger');
            } else {
                display.text('Data refresh status unknown.');
                display.addClass('text-danger');
            }
        }

        // Function to check if a refresh is in progress when the page loads
        function checkRefreshStatus() {
            fetch('/api/refresh-status')
                .then(response => response.json())
                .then(status => {
                    if (status.running) {
                        console.log('Detected refresh in progress on page load');
                        
                        // Calculate elapsed time
                        const startTime = new Date(status.started);
                        const now = new Date();
                        const elapsedSeconds = Math.round((now - startTime) / 1000);
                        const minutes = Math.floor(elapsedSeconds / 60);
                        const seconds = elapsedSeconds % 60;
                        const timeStr = `${minutes}m ${seconds.toString().padStart(2, '0')}s`;
                        
                        // Update UI to show refresh in progress
                        const btn = $('#fetchLatestButton');
                        const refreshStatusBanner = $('#refreshStatusBanner');
                        
                        // Disable button
                        btn.prop('disabled', true).html('Refresh In Progress');
                        
                        // Show status banner
                        refreshStatusBanner.html(`Data refresh in progress (${timeStr}) - please wait...`)
                                       .removeClass('text-success text-danger')
                                       .addClass('text-primary')
                                       .show();
                        
                        // Show toast
                        const toastId = showToast(`Data refresh running (${timeStr})<br>This may take several minutes depending on the amount of data.`, 'info', 0, 'Data Refresh In Progress');
                        
                        // Start a timer to update the elapsed time
                        let refreshTimerSeconds = elapsedSeconds;
                        const refreshTimer = setInterval(() => {
                            refreshTimerSeconds++;
                            const mins = Math.floor(refreshTimerSeconds / 60);
                            const secs = refreshTimerSeconds % 60;
                            const newTimeStr = `${mins}m ${secs.toString().padStart(2, '0')}s`;
                            
                            // Update the status banner with elapsed time
                            refreshStatusBanner.html(`Data refresh in progress (${newTimeStr}) - please wait...`);
                            
                            // Also update the toast
                            updateToast(toastId, `Data refresh running (${newTimeStr})<br>This may take several minutes depending on the amount of data.`);
                            
                            // Poll for status updates
                            fetch('/api/refresh-status')
                                .then(response => response.json())
                                .then(updatedStatus => {
                                    if (!updatedStatus.running) {
                                        // Refresh completed
                                        clearInterval(refreshTimer);
                                        
                                        // Re-enable button
                                        btn.prop('disabled', false).html('<i class="fas fa-sync-alt"></i> Refresh Data');
                                        
                                        if (updatedStatus.exitCode === 0) {
                                            // Success
                                            refreshStatusBanner.html('Data refresh completed successfully!')
                                                              .removeClass('text-primary')
                                                              .addClass('text-success');
                                            
                                            updateToast(toastId, 'Data refresh completed successfully! Loading updated data...', 'success');
                                            
                                            // Update last fetch time
                                            lastDataFetchTime = new Date();
                                            updateLastDataFetch(true);
                                            
                                            // Set a timeout to hide the banner after 10 seconds
                                            setTimeout(() => {
                                                refreshStatusBanner.fadeOut('slow');
                                            }, 10000);
                                            
                                            // Load the updated data
                                            loadAllData();
                                        } else {
                                            // Error
                                            refreshStatusBanner.html(`Error refreshing data: Exit code ${updatedStatus.exitCode}`)
                                                              .removeClass('text-primary')
                                                              .addClass('text-danger');
                                            
                                            updateToast(toastId, `Error refreshing data: Exit code ${updatedStatus.exitCode}`, 'error');
                                            
                                            // Try to load data anyway
                                            loadAllData();
                                        }
                                    }
                                })
                                .catch(error => {
                                    console.error("Error checking refresh status:", error);
                                });
                        }, 1000);
                    }
                })
                .catch(error => {
                    console.error("Error checking initial refresh status:", error);
                });
        }

         // --- Initial Setup ---
        $(document).ready(function() { /* ... (document.ready remains the same) ... */
             initializeTheme();
             initializeCharts(); initializeDateRangePicker(); updateLastDataFetch(false);
             
             // Check if a refresh is in progress when the page loads
             checkRefreshStatus();
             
             loadAllData();
             
             // Set up theme toggler
             $('#themeToggle').on('click', function() {
                 toggleTheme();
             });
             
             $('#agentFilter').on('change', function() { logFrontendEvent(`Agent filter changed: ${$(this).val()}`); populateUserFilter(); applyFiltersAndRefresh(); });
             $('#userFilter').on('change', function() { logFrontendEvent(`User filter changed: ${$(this).val()}`); applyFiltersAndRefresh(); });
             
             $('#fetchLatestButton').on('click', function() { 
    const btn = $(this);
    const refreshStatusBanner = $('#refreshStatusBanner');
    
    // Disable button for the entire refresh process
    btn.prop('disabled', true).html('Refresh In Progress');
    logFrontendEvent('Manual refresh initiated...');
    
    // Show immediate feedback in the status banner
    refreshStatusBanner.html('Data refresh started - this may take several minutes...')
                       .removeClass('text-success text-danger')
                       .addClass('text-primary')
                       .show();
    
    // Show initial toast with infinite duration (we'll update it as the process progresses)
    const toastId = showToast('Data refresh is running in the background. This may take several minutes depending on the amount of data.', 'info', 0, 'Data Refresh Started');
    
    // Create a refresh timer to show elapsed time
    let elapsedSeconds = 0;
    const refreshTimer = setInterval(() => {
        elapsedSeconds++;
        const minutes = Math.floor(elapsedSeconds / 60);
        const seconds = elapsedSeconds % 60;
        const timeStr = `${minutes}m ${seconds.toString().padStart(2, '0')}s`;
        
        // Update the status banner with elapsed time
        refreshStatusBanner.html(`Data refresh in progress (${timeStr}) - please wait...`);
        
        // Also update the toast
        updateToast(toastId, `Data refresh running (${timeStr})<br>This may take several minutes depending on the amount of data.`);
    }, 1000);
    
    // First call the API to trigger data refresh on the server
    fetch('/api/refresh-data', {
        method: 'POST'
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`Server returned ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        logFrontendEvent('Data refresh started in background: ' + JSON.stringify(data));
        
        if (data.success) {
            // Start polling for status
            return pollRefreshStatus()
                .then(finalStatus => {
                    // Stop the timer
                    clearInterval(refreshTimer);
                    
                    // Show completion message
                    refreshStatusBanner.html('Data refresh completed successfully!')
                                       .removeClass('text-primary')
                                       .addClass('text-success');
                    
                    // Update toast with success message
                    updateToast(toastId, 'Data refresh completed successfully! Loading updated data...', 'success');
                    
                    // Clear localStorage timestamp to ensure we get a fresh value
                    localStorage.removeItem('dashboardLastDataFetch');
                    
                    // Set a new timestamp and update display
                    lastDataFetchTime = new Date();
                    updateLastDataFetch(true);
                    
                    // Set a timeout to hide the banner after 10 seconds
                    setTimeout(() => {
                        refreshStatusBanner.fadeOut('slow');
                    }, 10000);
                    
                    return loadAllData();
                });
        } else {
            throw new Error(data.message || 'Unknown error');
        }
    })
    .catch(error => {
        // Stop the timer
        clearInterval(refreshTimer);
        
        console.error('Error refreshing data:', error);
        
        // Update status banner with error
        refreshStatusBanner.html(`Error refreshing data: ${error.message}`)
                           .removeClass('text-primary')
                           .addClass('text-danger');
        
        // Update toast with error
        updateToast(toastId, `Error refreshing data: ${error.message}`, 'error');
        
        // Try to load existing data anyway
        return loadAllData();
    })
    .finally(() => {
        // Re-enable the button but keep the status message until it fades
        btn.prop('disabled', false).html('<i class="fas fa-sync-alt"></i> Refresh Data');
    });
});
             $('#dailyChartMetricToggle').on('click', 'button', function() { $(this).addClass('active').siblings().removeClass('active'); updateDailyUsageChart(); });
             $('#dataTabs button[data-bs-toggle="tab"]').on('shown.bs.tab', function (event) { const targetTabId = $(event.target).attr('id').split('-')[0]; logFrontendEvent(`Tab switched to: ${targetTabId}`); if (tableState[targetTabId]) tableState[targetTabId].currentPage = 1; else console.warn(`State not found for tab: ${targetTabId}`); updateActiveTable(); });
             setTimeout(() => { setupTableSorting('userTable', 'user', userColumns); setupTableSorting('conversationTable', 'conversation', conversationColumns); setupTableSorting('sessionTable', 'session', sessionColumns); setupTableSorting('agentTable', 'agent', agentColumns); setupTableSorting('modelTable', 'model', modelColumns); }, 500);
             setInterval(() => updateLastDataFetch(true), 60 * 1000);

             // Set up event handler for viewing trace graph
             $(document).on('click', '.view-trace-graph', async function() {
                 const traceId = $(this).data('trace-id');
                 
                 // Show the modal
                 const traceGraphModal = new bootstrap.Modal(document.getElementById('traceGraphModal'));
                 traceGraphModal.show();
                 
                 // Fetch and render the trace data
                 const observations = await fetchTraceObservations(traceId);
                 renderTraceGraph(traceId, observations);
             });
        });

        // Trace Graph Functionality
        async function fetchTraceObservations(traceId) {
            try {
                // Show loading spinner
                $('#traceGraphLoading').show();
                $('#traceGraphContainer').hide();
                
                // Find the trace data in our current filtered dataset
                // Allow partial matching if the ID is shortened
                const partialId = traceId.substring(0, 8);
                const trace = filteredData.traces.find(t => 
                    t.id === traceId || t.id.startsWith(partialId)
                );
                
                if (!trace) {
                    throw new Error("Trace not found");
                }
                
                console.log(`Fetching observations for trace: ${trace.id}, tokens: ${trace.totalTokens}, messages: ${trace.messageCount}`);
                
                // Fetch real observation data from our API endpoint
                // We'll pass just the first part of the ID if it's a UUID (commonly displayed shortened in UI)
                const searchId = traceId.length === 36 ? traceId : traceId.substring(0, 8);
                const response = await fetch(`/api/traces/${searchId}/observations`);
                
                if (!response.ok) {
                    // If we can't get real data, fall back to simulation
                    console.warn(`Could not fetch real observation data for trace ${searchId}. Status: ${response.status}`);
                    return generateSimulatedData(trace);
                }
                
                const data = await response.json();
                
                if (!data.toolCalls || data.toolCalls.length === 0) {
                    console.warn(`No tool calls found for trace ${searchId}, using simulated data`);
                    return generateSimulatedData(trace);
                }
                
                console.log(`Retrieved ${data.toolCalls.length} tool calls, total tokens: ${data.totalTraceTokens}`);
                
                // Compare the token count from the trace with what we got from observations
                if (trace.totalTokens && data.totalTraceTokens && 
                    Math.abs(trace.totalTokens - data.totalTraceTokens) / trace.totalTokens > 0.2) {
                    console.warn(`Token count discrepancy: trace has ${trace.totalTokens} tokens, ` +
                                 `but observations sum to ${data.totalTraceTokens} tokens`);
                }
                
                // Sort the tool calls by number to ensure correct order
                // Include all observations, even those with zero tokens
                return data.toolCalls.sort((a, b) => a.toolCallNumber - b.toolCallNumber);
                
            } catch (error) {
                console.error("Error fetching trace observations:", error);
                // Fall back to simulated data if real data fetch fails
                return generateSimulatedData(trace);
            }
        }

        // Helper function to generate simulated data if real data is unavailable
        function generateSimulatedData(trace) {
            // THIS IS FAKE DATA FOR DEMONSTRATION ONLY
            console.warn("Generating simulated data as fallback");
            
            const messageCount = trace.messageCount || 10;
            const totalTokens = trace.totalTokens || 1000;
            
            // Simulate tool call data
            // THIS IS NOT REAL DATA - just a simulation
            const observations = [];
            
            // In reality, the number of tool calls would come from actual observation data
            const simulatedToolCallCount = Math.min(Math.max(Math.ceil(messageCount * 0.3), 3), 20);
            
            // Distribute tokens across tools following a somewhat realistic pattern
            const toolCallTokens = [];
            let remainingTokens = totalTokens;
            
            // Generate some random token amounts for tool calls
            for (let i = 0; i < simulatedToolCallCount - 1; i++) {
                // Each tool call gets between 3-20% of remaining tokens
                const tokenPercentage = 0.03 + Math.random() * 0.17;
                const tokenAmount = Math.floor(remainingTokens * tokenPercentage);
                toolCallTokens.push(tokenAmount);
                remainingTokens -= tokenAmount;
            }
            
            // Last tool call gets all remaining tokens
            toolCallTokens.push(remainingTokens);
            
            // Create simulated tool calls with the token amounts
            for (let i = 0; i < simulatedToolCallCount; i++) {
                observations.push({
                    toolCallNumber: i + 1,
                    tokenUsage: toolCallTokens[i],
                    name: `Simulated Tool Call ${i + 1}`
                });
            }
            
            return observations;
        }

        function renderTraceGraph(traceId, observations) {
            // Hide loading spinner
            $('#traceGraphLoading').hide();
            $('#traceGraphContainer').show();
            
            // Check if we have valid data
            if (!observations || observations.length === 0) {
                document.getElementById('traceGraphContainer').innerHTML = '<div class="alert alert-warning text-center">No observation data available for this trace.</div>';
                return;
            }
            
            // Find the trace data
            const partialId = traceId.substring(0, 8);
            const trace = filteredData.traces.find(t => t.id === traceId || t.id.startsWith(partialId));
            const agentName = trace ? trace.agent : '';
            
            // Sort observations by toolCallNumber to ensure correct order
            observations.sort((a, b) => a.toolCallNumber - b.toolCallNumber);
            
            // Prepare data for the chart - include ALL observations
            // Just use simple numbers for the x-axis
            const labels = observations.map((obs, index) => (index + 1).toString());
            const tokenData = observations.map(obs => obs.tokenUsage || 0);
            
            // Calculate the total tokens from non-zero observations
            const totalGraphTokens = tokenData.reduce((sum, curr) => sum + curr, 0);
            
            // Create the chart context
            const ctx = document.getElementById('traceGraph').getContext('2d');
            
            // Get theme-specific colors
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const textColor = currentTheme === 'dark' ? '#e9ecef' : '#343a40';
            const gridColor = currentTheme === 'dark' ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
            const backgroundColor = currentTheme === 'dark' ? 'rgba(94, 114, 228, 0.2)' : 'rgba(54, 162, 235, 0.2)';
            const borderColor = currentTheme === 'dark' ? 'rgba(94, 114, 228, 1)' : 'rgba(54, 162, 235, 1)';
            const pointBackgroundColor = currentTheme === 'dark' ? 'rgba(94, 114, 228, 1)' : 'rgba(54, 162, 235, 1)';
            
            // Destroy any existing chart
            if (window.traceChart) {
                window.traceChart.destroy();
            }
            
            // Create a line chart
            window.traceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Token Usage',
                        data: tokenData,
                        backgroundColor: backgroundColor,
                        borderColor: borderColor,
                        borderWidth: 2,
                        pointBackgroundColor: pointBackgroundColor,
                        pointRadius: 3,
                        tension: 0.1, // Slight curve to the lines
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Token Count',
                                color: textColor
                            },
                            grid: {
                                color: gridColor
                            },
                            ticks: {
                                color: textColor
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Observation Number',
                                color: textColor
                            },
                            grid: {
                                color: gridColor
                            },
                            ticks: {
                                autoSkip: false,
                                color: textColor
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                title: function(tooltipItems) {
                                    const idx = tooltipItems[0].dataIndex;
                                    const obsNumber = idx + 1;
                                    const obs = observations[idx];
                                    return `Observation ${obsNumber}`;
                                },
                                label: function(context) {
                                    return `Tokens: ${context.raw.toLocaleString()}`;
                                },
                                afterLabel: function(context) {
                                    const idx = context.dataIndex;
                                    const obs = observations[idx];
                                    return obs.name ? `Type: ${obs.name}` : '';
                                }
                            }
                        },
                        legend: {
                            display: false,
                            labels: {
                                color: textColor
                            }
                        },
                        title: {
                            display: true,
                            text: `Token Usage (Total: ${totalGraphTokens.toLocaleString()} tokens)`,
                            color: textColor
                        }
                    }
                }
            });
            
            // Just show the observation count in the summary section
            document.getElementById('traceGraphSummary').textContent = 
                `${observations.length} total observations`;
            
            // Create a table with non-zero token observations
            const nonZeroObservations = observations.filter(obs => (obs.tokenUsage || 0) > 0);
            
            if (nonZeroObservations.length > 0) {
                const tableHtml = `
                    <table class="table table-sm table-striped">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Name</th>
                                <th class="text-end">Tokens</th>
                                <th class="text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${nonZeroObservations.map((obs, index) => {
                                // Get the observation URL
                                const obsLink = obs.id ? getLangfuseObservationUrl(obs.id, agentName, obs.timestamp) : '';
                                return `
                                    <tr>
                                        <td>${obs.toolCallNumber}</td>
                                        <td>${obs.name || 'Unknown'}</td>
                                        <td class="text-end">${obs.tokenUsage.toLocaleString()}</td>
                                        <td class="text-center">${obs.id ? 
                                            `<a href="${obsLink}" class="btn btn-sm btn-outline-secondary langfuse-btn" target="_blank" title="View observation details in Langfuse">View Details</a>` : 
                                            '—'}
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `;
                document.getElementById('tokenTableContainer').innerHTML = tableHtml;
            } else {
                document.getElementById('tokenTableContainer').innerHTML = 
                    '<div class="alert alert-warning">No observations with token data found.</div>';
            }
        }

        // Toast notification functions
        function showToast(message, type = 'info', duration = 5000, title = '') {
            // Create toast element
            const toastId = 'toast-' + Date.now();
            const toast = $(`
                <div id="${toastId}" class="toast toast-${type}" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="toast-header">
                        <strong class="mr-auto">${title || (type.charAt(0).toUpperCase() + type.slice(1))}</strong>
                        <span class="close">&times;</span>
                    </div>
                    <div class="toast-body">${message}</div>
                    <div class="toast-progress"></div>
                </div>
            `);
            
            // Add to container
            $('.toast-container').append(toast);
            
            // Handle close button
            toast.find('.close').on('click', function() {
                removeToast(toastId);
            });
            
            // Animate progress bar
            const progressBar = toast.find('.toast-progress');
            progressBar.animate({ width: '100%' }, duration);
            
            // Auto remove after duration
            if (duration > 0) {
                setTimeout(() => {
                    removeToast(toastId);
                }, duration);
            }
            
            return toastId;
        }
        
        function removeToast(toastId) {
            const toast = $(`#${toastId}`);
            toast.fadeOut(300, function() {
                $(this).remove();
            });
        }
        
        function updateToast(toastId, message, type = null) {
            const toast = $(`#${toastId}`);
            if (toast.length === 0) return;
            
            toast.find('.toast-body').html(message);
            
            if (type) {
                toast.removeClass('toast-info toast-success toast-warning toast-error')
                     .addClass(`toast-${type}`);
                
                toast.find('.toast-progress')
                    .css('background-color', type === 'success' ? '#28a745' : 
                                             type === 'warning' ? '#ffc107' : 
                                             type === 'error' ? '#dc3545' : 
                                             'var(--primary-color)');
            }
        }
        
        // Function to poll for script status
        function pollRefreshStatus() {
            return new Promise((resolve, reject) => {
                let pollInterval;
                
                const checkStatus = () => {
                    fetch('/api/refresh-status')
                        .then(response => response.json())
                        .then(status => {
                            // If script is no longer running, we're done
                            if (!status.running) {
                                clearInterval(pollInterval);
                                
                                if (status.exitCode === 0) {
                                    resolve(status);
                                } else {
                                    reject(new Error(`Script failed with exit code ${status.exitCode}`));
                                }
                                return;
                            }
                        })
                        .catch(error => {
                            console.error('Error checking refresh status:', error);
                            // Keep polling even if there's an error
                        });
                };
                
                // Start polling every 3 seconds (we already have a 1-second UI update timer)
                pollInterval = setInterval(checkStatus, 3000);
                
                // Initial check
                checkStatus();
            });
        }
    </script>
</body>
</html>